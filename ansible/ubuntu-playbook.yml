---
  - name: VM
    hosts: all
    become: yes
    become_user: root

    tasks:
      - name: update package cache
        apt:
          update_cache: yes
          upgrade: dist
          
      - name: reboot from update
        reboot:
          reboot_timeout: 90

      - name: install needed packages
        apt:
          name:
            - openjdk-17-jre-headless
            - nginx
            - mariadb-client
            - mariadb-server

      - name: enable services
        service:
          name: "{{ item }}"
          enabled: yes
          state: started
        with_items:
          - nginx
          - mariadb

      - name: Create certifcate directories
        become: true
        file:
          path: /etc/pki/nginx/private
          state: directory
          mode: '755'
      
      - name: Install Python cryptography libs for certificate creation
        become: true
        yum:
          name: python3-cryptography
          state: present
      
      - name: Generate private key
        become: true
        openssl_privatekey:
          path: /etc/pki/nginx/private/server.key
          size: 2048
      
      - name: Generate certificate signing request
        become: true
        openssl_csr:
          path: /etc/ssl/certs/server.crt
          privatekey_path: /etc/pki/nginx/private/server.key
      
      - name: Generate self-signed certificate
        become: true
        openssl_certificate:
          path: /etc/pki/nginx/server.crt
          csr_path: /etc/ssl/certs/server.crt
          privatekey_path: /etc/pki/nginx/private/server.key
          provider: selfsigned

      - name: copy Nginx https config
        become: true
        copy:
          src: https.conf
          dest: /etc/nginx/conf.d
      
      - name: Start/Restart Nginx
        become: true
        systemd:
          name: nginx
          state: reloaded

      - name: Open ssh port
        become: true
        ufw:
          rule: allow
          name: OpenSSH

      - name: Open https port
        become: true
        ufw:
          rule: allow
          name: Nginx HTTPS

      - name: Turn on UFW
        ufw:
          state: enabled
